<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ELDA MAZZOCCHI SCARZELLA- In gioco</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="style.css">
  <script src="js/theme.js" defer></script>
  </head>

<body class="player-page">
  
  <div class="player-header">ELDA MAZZOCCHI SCARZELLA - <span id="nick"></span></div>

  <div class="player-main">
    
    <div id="waitingSection">In attesa del presentatore...</div>

    <div id="pinSection" class="hidden">
      <div>Inserisci PIN</div>
      <div class="pin-box">
        <input id="joinPin" type="text" maxlength="6" placeholder="483920" class="input-field" style="margin:0; width: 160px;" />
        <button class="btn btn-primary" onclick="joinWithPin()" style="padding: 0.8rem 1rem;">Partecipa</button>
      </div>
      <div id="playerMsg" style="font-size: 1rem; margin-top: 1rem;"></div>
    </div>

    <div id="thanksSection" class="hidden">Grazie! Risposta inviata.</div>
    
  </div> <div id="quizSection" class="hidden">
    </div>
  
  <div class="player-answers-grid" id="answersContainer">
    </div>


  <script type="module">
    // Importa le funzioni
    import { db, doc, getDoc, onSnapshot, setDoc, collection } from "./js/firebase.js";

    // ... (tutto il codice helper getPlayerId, getParam, ecc. rimane uguale) ...
    let currentPresentationId = null;
    let currentSlideIndex = -1;
    let currentSlideData = null;
    let currentPresentationData = null; 
    let answered = false;
    const PLAYER_KEY = 'elda_player_id';

    function getPlayerId() {
      let id = localStorage.getItem(PLAYER_KEY);
      if (!id) {
        id = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,9);
        localStorage.setItem(PLAYER_KEY, id);
      }
      return id;
    }

    function getParam(name) { return new URLSearchParams(window.location.search).get(name); }
    
    // Elementi UI
    const nickEl = document.getElementById('nick');
    const pinInput = document.getElementById('joinPin');
    const msgEl = document.getElementById('playerMsg');
    
    // Sezioni
    const waitingSection = document.getElementById('waitingSection');
    const pinSection = document.getElementById('pinSection');
    const thanksSection = document.getElementById('thanksSection');
    const quizSection = document.getElementById('quizSection'); // Questo ora è solo un contenitore
    const answersContainer = document.getElementById('answersContainer');
    
    // ✨ NUOVO: Aggiungiamo un contenitore per la domanda dentro player-main
    const questionEl = document.createElement('div');
    questionEl.id = 'quizQuestion';
    questionEl.style.display = 'none'; // Nascosto di default
    document.getElementById('waitingSection').parentElement.appendChild(questionEl);


    // UI helpers
    function showContent(sectionId) {
      // Nascondi tutti i contenuti principali
      waitingSection.style.display = 'none';
      pinSection.style.display = 'none';
      thanksSection.style.display = 'none';
      questionEl.style.display = 'none';
      answersContainer.style.display = 'none'; // Nascondi anche la griglia

      if (sectionId === 'waiting') waitingSection.style.display = 'block';
      if (sectionId === 'pin') pinSection.style.display = 'block';
      if (sectionId === 'thanks') thanksSection.style.display = 'block';
      if (sectionId === 'quiz') {
        questionEl.style.display = 'block';
        answersContainer.style.display = 'grid'; // Mostra la griglia
      }
    }
    
    function showMessage(text) {
      if (msgEl) msgEl.textContent = text;
    }
    
    if(nickEl) nickEl.textContent = decodeURIComponent(getParam('nick') || 'Giocatore');
    if(pinInput) pinInput.value = getParam('pin') || '';


    // Listener Globale
    onSnapshot(doc(db, 'status', 'livePresentation'), async (snap) => {
      const data = snap.data();
      
      if (data && data.activeId && data.currentSlide >= 0) {
        if (currentPresentationId !== data.activeId) {
          // ... (logica invariata)
          currentPresentationId = data.activeId;
          currentSlideIndex = -1; 
          currentPresentationData = null;
          answered = false;
          
          showMessage('Presentazione attiva. Inserisci PIN.');
          showContent('pin');
        }
        
        if (currentSlideIndex !== data.currentSlide && currentPresentationData) {
          currentSlideIndex = data.currentSlide;
          answered = false; 
          loadQuizSlide();
        }

      } else {
        // ... (logica invariata)
        currentPresentationId = null;
        currentSlideIndex = -1;
        currentPresentationData = null;
        showMessage('In attesa del presentatore...');
        showContent('waiting');
      }
    });

    // Verifica PIN
    window.joinWithPin = async function() {
      const pin = (document.getElementById('joinPin') || {}).value || '';
      if (!currentPresentationId) return showMessage('Nessuna presentazione attiva.');
      if (!pin) return showMessage('Inserisci il PIN.');

      try {
        const pSnap = await getDoc(doc(db, 'presentations', currentPresentationId));
        if (!pSnap.exists()) return showMessage('Presentazione non trovata.');
        
        currentPresentationData = pSnap.data();
        
        if (String(currentPresentationData.pin) !== String(pin)) {
          currentPresentationData = null;
          return showMessage('PIN non corretto.');
        }

        const liveStatus = await getDoc(doc(db, "status", "livePresentation"));
        currentSlideIndex = liveStatus.data().currentSlide;
        
        loadQuizSlide();
        
      } catch (err) {
        console.error('Errore verifica PIN:', err);
        showMessage('Errore durante la verifica del PIN.');
      }
    };

    // Carica Slide
    function loadQuizSlide() {
      if (!currentPresentationData || currentSlideIndex < 0) return;

      currentSlideData = currentPresentationData.slides[currentSlideIndex];
      if (!currentSlideData) return;

      // ✨ MODIFICA: Aggiorna il nuovo elemento domanda
      questionEl.textContent = currentSlideData.question || '';

      answersContainer.innerHTML = '';
      const colors = ['btn-red', 'btn-blue', 'btn-yellow', 'btn-green']; 

      currentSlideData.answers.forEach((ans, idx) => {
        const btn = document.createElement('button');
        btn.textContent = String(ans);
        // ✨ MODIFICA: Usa le nuove classi
        btn.className = 'player-answer-btn ' + colors[idx % colors.length];
        btn.onclick = () => submitAnswer(idx);
        answersContainer.appendChild(btn);
      });

      showContent('quiz');
    }

    // Invia Risposta
    async function submitAnswer(answerIndex) {
      if (answered) return;
      answered = true;
      const playerId = getPlayerId();

      try {
        const respRef = doc(db, 'presentations', currentPresentationId, 'responses', `${playerId}_slide${currentSlideIndex}`);
        
        await setDoc(respRef, { 
          answer: answerIndex, 
          slide: currentSlideIndex,
          nick: nickEl.textContent, 
          ts: Date.now() 
        });
        
        showContent('thanks');
        
      } catch (err) {
        console.error('Errore invio risposta:', err);
        showMessage('Errore invio risposta. Riprova.');
        answered = false;
      }
    }
  </script>
</body>
</html>
